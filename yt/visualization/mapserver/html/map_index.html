<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<!-- Leaflet JavaScript -->
<script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/leaflet/1.2.0/leaflet.js"></script>
<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/leaflet/1.2.0/leaflet.css" />
<script type="text/javascript" src="//ajax.googleapis.com/ajax/libs/jquery/1.5.1/jquery.min.js"></script>
<script type="text/javascript">
function setFullScreen () {
    $("#map").width($(window).width());
    $("#map").height($(window).height());
}

var SearchWidget = function () {
  var obj = {
    filter: function (searchStrs) {
      console.log("filtering on " + searchStrs);
      this._selector.each(function(i, el) {
        var val = $(el).text();
        // Search
        var matched = searchStrs.map((str) => {
          return val.indexOf(str) !== -1;
        }).reduce((reduced, result) => {
          return reduced && result;
        }, true);
        if (matched) {
          $(el).show();
        } else {
          $(el).hide();
        }
      });
    },
    init: function () {
      var self = this;

      var searchElement = $('<div id="filter"><input type="text" placeholder="Filter layers"></div>');
      var selector = $('.leaflet-control-layers-list label');

      this._selector = selector;

      // Add input in the DOM
      selector.first().parent().prepend(searchElement);

      // Listen to keyboard input
      $('#filter input').keyup(function(ev) {
        const val = $(this).val();
        self.filter(val.split(" "));
      });

    },
    _selector: null
  };
  obj.init();
  return obj;
};
$(document).ready(function() {
  // Initialize to full screen
  setFullScreen();
  // initialize the map on the "map" div with a given center and zoom
  $.getJSON('/list', function(data) {
    var layers = [],
        layer_groups = [],
        default_layer = [null];
    var layer_group = {};

    // Loop over field types
    for (var type in data['data']) {
      var dtype = data['data'][type];

      // Loop over fields of given type
      for (var field in dtype) {
        var loc = dtype[field]
        var field = loc[0],
            active = loc[1],
            url = 'map/' + field[0] + ',' + field[1] + '/{z}/{x}/{y}.png';

        // Create new layer
        var layer = new L.TileLayer(url, {id: 'MapID', maxzoom: 18});

        // Create readable name
        human_name = field.join(' ');

        // Store it
        layers.push(layer);
        layer_group[human_name] = layer;
        if (active) {
          default_layer[0] = layer;
        }
      }
    }
    var map = new L.Map('map', {
      center: new L.LatLng(0., 0.),
      zoom: 2,
      layers: default_layer,
    });
    L.control.layers(layer_group).addTo(map);

    // Search widget
    var search = SearchWidget();
  });

  // Resize map automatically
  $(window).resize(setFullScreen);
});

</script>
<style>
body {
    margin: 0;
}
</style>
</head>
<body>
  <div id="map" style="height: 500px; width: 500px;"></div>
</body>
</html>
